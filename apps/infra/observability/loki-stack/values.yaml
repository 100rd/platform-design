global:
  # Global cluster information
  clusterName: gaming-production-eks
  environment: production

  # Multi-architecture support
  image:
    registry: docker.io

# Loki Configuration - Simple Scalable Mode
loki:
  enabled: true

  # Deployment mode: SimpleScalable (Read/Write/Backend separation)
  deploymentMode: SimpleScalable

  loki:
    # Common configuration
    auth_enabled: true  # Multi-tenant mode

    # Server configuration
    server:
      http_listen_port: 3100
      grpc_listen_port: 9095
      log_level: info

    # Limits configuration - prevent runaway queries
    limits_config:
      # Ingestion limits
      ingestion_rate_mb: 50  # MB per second per tenant
      ingestion_burst_size_mb: 100
      max_streams_per_user: 100000
      max_global_streams_per_user: 500000

      # Query limits
      max_query_length: 721h  # 30 days
      max_query_lookback: 721h
      max_query_parallelism: 32
      max_query_series: 10000
      max_entries_limit_per_query: 50000
      max_cache_freshness_per_query: 10m

      # Chunk limits
      max_chunk_age: 2h
      max_chunks_per_query: 2000000

      # Retention
      retention_period: 720h  # 30 days

      # Split queries by interval
      split_queries_by_interval: 30m

      # Cardinality limits
      cardinality_limit: 100000
      max_label_names_per_series: 30

      # Per stream rate limits
      per_stream_rate_limit: 5MB
      per_stream_rate_limit_burst: 20MB

    # Storage configuration - S3 backend
    storage:
      type: s3
      bucketNames:
        chunks: loki-chunks
        ruler: loki-ruler
        admin: loki-admin
      s3:
        region: us-east-1
        endpoint: s3.us-east-1.amazonaws.com
        secretAccessKey: ${S3_SECRET_KEY}  # Injected from secret
        accessKeyId: ${S3_ACCESS_KEY}      # Injected from secret
        s3ForcePathStyle: false
        insecure: false
        http_config:
          idle_conn_timeout: 90s
          response_header_timeout: 0s
          insecure_skip_verify: false

    # Schema configuration
    schemaConfig:
      configs:
        - from: 2024-01-01
          store: tsdb
          object_store: s3
          schema: v13
          index:
            prefix: loki_index_
            period: 24h

    # Compactor - for retention and index cleanup
    compactor:
      working_directory: /var/loki/compactor
      compaction_interval: 10m
      retention_enabled: true
      retention_delete_delay: 2h
      retention_delete_worker_count: 150
      delete_request_store: s3

    # Query scheduler
    query_scheduler:
      max_outstanding_requests_per_tenant: 2048

    # Frontend configuration
    frontend:
      max_outstanding_per_tenant: 4096
      compress_responses: true
      log_queries_longer_than: 5s

    # Querier configuration
    querier:
      max_concurrent: 16
      query_timeout: 5m

    # Ingester configuration
    ingester:
      chunk_idle_period: 30m
      chunk_block_size: 262144
      chunk_encoding: snappy
      chunk_retain_period: 1m
      max_chunk_age: 2h

      # WAL configuration
      wal:
        enabled: true
        dir: /var/loki/wal
        replay_memory_ceiling: 4GB

    # Ruler configuration
    ruler:
      enable_api: true
      enable_alertmanager_v2: true
      storage:
        type: s3
        s3:
          bucketnames: loki-ruler

    # Analytics
    analytics:
      reporting_enabled: false

  # Read component - handles queries
  read:
    replicas: 3

    resources:
      requests:
        cpu: 500m
        memory: 2Gi
      limits:
        cpu: 2000m
        memory: 4Gi

    # Anti-affinity to spread across nodes
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  app.kubernetes.io/component: read
              topologyKey: kubernetes.io/hostname

    # Auto-scaling
    autoscaling:
      enabled: true
      minReplicas: 3
      maxReplicas: 10
      targetCPUUtilizationPercentage: 70
      targetMemoryUtilizationPercentage: 80

    persistence:
      enabled: true
      size: 20Gi
      storageClass: gp3

    podDisruptionBudget:
      maxUnavailable: 1

  # Write component - handles ingestion
  write:
    replicas: 3

    resources:
      requests:
        cpu: 1000m
        memory: 4Gi
      limits:
        cpu: 2000m
        memory: 8Gi

    # Anti-affinity
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  app.kubernetes.io/component: write
              topologyKey: kubernetes.io/hostname

    # Auto-scaling for write path
    autoscaling:
      enabled: true
      minReplicas: 3
      maxReplicas: 15
      targetCPUUtilizationPercentage: 70
      targetMemoryUtilizationPercentage: 75

    # Larger persistent volume for WAL
    persistence:
      enabled: true
      size: 50Gi
      storageClass: gp3

    podDisruptionBudget:
      maxUnavailable: 1

  # Backend component - compactor, ruler, etc.
  backend:
    replicas: 2

    resources:
      requests:
        cpu: 500m
        memory: 2Gi
      limits:
        cpu: 1500m
        memory: 4Gi

    # Anti-affinity
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  app.kubernetes.io/component: backend
              topologyKey: kubernetes.io/hostname

    persistence:
      enabled: true
      size: 30Gi
      storageClass: gp3

    podDisruptionBudget:
      maxUnavailable: 1

  # Gateway - load balancer for Loki components
  gateway:
    enabled: true
    replicas: 2

    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 256Mi

    service:
      type: ClusterIP
      port: 80
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"

    ingress:
      enabled: false  # Use internal access only

  # Monitoring
  monitoring:
    serviceMonitor:
      enabled: true
      interval: 30s
      scrapeTimeout: 10s

    selfMonitoring:
      enabled: true
      grafanaAgent:
        installOperator: false

    lokiCanary:
      enabled: true
      resources:
        requests:
          cpu: 10m
          memory: 16Mi
        limits:
          cpu: 100m
          memory: 64Mi

  # Test suite
  test:
    enabled: false

# Fluent Bit Configuration - Efficient Log Collection
fluent-bit:
  enabled: true

  # DaemonSet mode - run on every node
  kind: DaemonSet

  # Image configuration
  image:
    repository: fluent/fluent-bit
    tag: 3.1.9
    pullPolicy: IfNotPresent

  # Service account
  serviceAccount:
    create: true
    name: fluent-bit

  # RBAC permissions to read pod metadata
  rbac:
    create: true
    nodeAccess: true  # Access to node logs

  # Resources - keep footprint low
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Tolerations - run on ALL nodes including Karpenter provisioned
  tolerations:
    - operator: Exists
      effect: NoSchedule
    - operator: Exists
      effect: NoExecute

  # Priority to ensure log collection continues
  priorityClassName: system-node-critical

  # Host network for better performance
  hostNetwork: false
  dnsPolicy: ClusterFirst

  # Update strategy
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 10%

  # Volume mounts for log collection
  volumeMounts:
    - name: varlog
      mountPath: /var/log
      readOnly: true
    - name: varlibdockercontainers
      mountPath: /var/lib/docker/containers
      readOnly: true
    - name: etcmachineid
      mountPath: /etc/machine-id
      readOnly: true

  volumes:
    - name: varlog
      hostPath:
        path: /var/log
    - name: varlibdockercontainers
      hostPath:
        path: /var/lib/docker/containers
    - name: etcmachineid
      hostPath:
        path: /etc/machine-id
        type: File

  # Configuration
  config:
    # Service configuration
    service: |
      [SERVICE]
          Daemon Off
          Flush 5
          Log_Level info
          Parsers_File /fluent-bit/etc/parsers.conf
          Parsers_File /fluent-bit/etc/custom_parsers.conf
          HTTP_Server On
          HTTP_Listen 0.0.0.0
          HTTP_Port 2020
          Health_Check On
          storage.path /var/fluent-bit/state/flb-storage/
          storage.sync normal
          storage.checksum off
          storage.max_chunks_up 128
          storage.backlog.mem_limit 10M

    # Input - Container logs
    inputs: |
      [INPUT]
          Name tail
          Path /var/log/containers/*.log
          multiline.parser docker, cri, go, java, python
          Tag kube.*
          Mem_Buf_Limit 50MB
          Skip_Long_Lines On
          Skip_Empty_Lines On
          Refresh_Interval 10
          DB /var/fluent-bit/state/flb_kube.db
          DB.sync normal
          storage.type filesystem
          Exclude_Path /var/log/containers/*_kube-system_*.log,/var/log/containers/*_kube-public_*.log,/var/log/containers/*_kube-node-lease_*.log

      [INPUT]
          Name systemd
          Tag host.*
          Systemd_Filter _SYSTEMD_UNIT=kubelet.service
          Systemd_Filter _SYSTEMD_UNIT=docker.service
          Systemd_Filter _SYSTEMD_UNIT=containerd.service
          Read_From_Tail On
          Strip_Underscores On
          DB /var/fluent-bit/state/flb_systemd.db

    # Filters - Kubernetes metadata enrichment
    filters: |
      [FILTER]
          Name kubernetes
          Match kube.*
          Kube_URL https://kubernetes.default.svc:443
          Kube_CA_File /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          Kube_Token_File /var/run/secrets/kubernetes.io/serviceaccount/token
          Kube_Tag_Prefix kube.var.log.containers.
          Merge_Log On
          Keep_Log Off
          K8S-Logging.Parser On
          K8S-Logging.Exclude On
          Labels On
          Annotations Off
          Buffer_Size 256KB

      [FILTER]
          Name modify
          Match kube.*
          Add cluster ${CLUSTER_NAME}
          Add environment production
          Add platform gaming

      [FILTER]
          Name modify
          Match host.*
          Add cluster ${CLUSTER_NAME}
          Add environment production
          Add platform gaming
          Add source systemd

      [FILTER]
          Name nest
          Match kube.*
          Operation lift
          Nested_under kubernetes
          Add_prefix k8s_

      [FILTER]
          Name modify
          Match kube.*
          Rename log message

      [FILTER]
          Name grep
          Match kube.*
          Exclude message ^\s*$

    # Output - Send to Loki
    outputs: |
      [OUTPUT]
          Name loki
          Match kube.*
          Host loki-stack-gateway.observability.svc.cluster.local
          Port 80
          Labels job=fluent-bit, cluster=${CLUSTER_NAME}
          Label_keys k8s_namespace_name,k8s_pod_name,k8s_container_name,k8s_labels_app,k8s_labels_component
          Remove_keys k8s_namespace_name,k8s_pod_name,k8s_container_name,k8s_host,k8s_pod_id,k8s_docker_id
          Auto_kubernetes_labels on
          Retry_Limit 3
          Retry_Wait 30
          storage.total_limit_size 1G
          tenant_id game-platform

      [OUTPUT]
          Name loki
          Match host.*
          Host loki-stack-gateway.observability.svc.cluster.local
          Port 80
          Labels job=fluent-bit-systemd, cluster=${CLUSTER_NAME}, source=systemd
          Retry_Limit 3
          Retry_Wait 30
          storage.total_limit_size 500M
          tenant_id game-platform

    # Custom parsers for multiline logs
    customParsers: |
      [PARSER]
          Name docker
          Format json
          Time_Key time
          Time_Format %Y-%m-%dT%H:%M:%S.%L%z
          Time_Keep On

      [PARSER]
          Name cri
          Format regex
          Regex ^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<message>.*)$
          Time_Key time
          Time_Format %Y-%m-%dT%H:%M:%S.%L%z
          Time_Keep On

      [MULTILINE_PARSER]
          name go
          type regex
          flush_timeout 1000
          rule "start_state" "/^(panic|fatal|error):/i" "cont"
          rule "cont" "/^\s+at\s/" "cont"

      [MULTILINE_PARSER]
          name java
          type regex
          flush_timeout 1000
          rule "start_state" "/^(\d{4}-\d{2}-\d{2}|\w{3}\s+\d{1,2})\s.*Exception/" "cont"
          rule "cont" "/^\s+(at|\.{3})\s/" "cont"
          rule "cont" "/^Caused by:/" "cont"

      [MULTILINE_PARSER]
          name python
          type regex
          flush_timeout 1000
          rule "start_state" "/^Traceback/" "cont"
          rule "cont" "/^\s+File/" "cont"
          rule "cont" "/^\s{2,}/" "cont"

  # Environment variables
  env:
    - name: CLUSTER_NAME
      value: gaming-production-eks

  # Liveness probe
  livenessProbe:
    httpGet:
      path: /api/v1/health
      port: 2020
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  # Readiness probe
  readinessProbe:
    httpGet:
      path: /api/v1/health
      port: 2020
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  # Service Monitor for Prometheus
  serviceMonitor:
    enabled: true
    interval: 30s
    scrapeTimeout: 10s
    labels:
      prometheus: kube-prometheus

  # Dashboard
  dashboards:
    enabled: true
    labelKey: grafana_dashboard
    labelValue: "1"

# Security
securityContext:
  runAsNonRoot: true
  runAsUser: 65534
  fsGroup: 65534
  seccompProfile:
    type: RuntimeDefault

podSecurityContext:
  runAsNonRoot: true
  seccompProfile:
    type: RuntimeDefault

# Network Policies
networkPolicy:
  enabled: true
