---
# Thanos Components Configuration
# Separate deployment from kube-prometheus-stack for independent scaling
# Architecture: Query Frontend -> Query -> Store Gateway -> S3
#                                      -> Sidecar (on Prometheus pods)

thanos:
  enabled: true

  # Docker image configuration
  image:
    registry: quay.io
    repository: thanos/thanos
    tag: v0.36.1
    pullPolicy: IfNotPresent

  # Object Storage Configuration (S3)
  objstoreConfig: |-
    type: S3
    config:
      bucket: "thanos-metrics-us-east-1"  # Replace with your bucket
      endpoint: "s3.us-east-1.amazonaws.com"
      region: "us-east-1"
      # IRSA (IAM Roles for Service Accounts) - no credentials needed
      # Alternatively, use AWS credentials:
      # access_key: ""
      # secret_key: ""
      sse_config:
        type: "SSE-S3"  # Server-side encryption
      http_config:
        idle_conn_timeout: 90s
        response_header_timeout: 2m
      trace:
        enable: true
      part_size: 134217728  # 128MB upload parts
      # Lifecycle policy applied via Terraform:
      # - transition to IA after 30d
      # - transition to Glacier after 90d
      # - delete after 365d

  # --------------------------------------------------------------------------
  # Query Frontend - Caching layer for queries
  # --------------------------------------------------------------------------
  queryFrontend:
    enabled: true
    replicaCount: 2

    # Service configuration
    service:
      type: ClusterIP
      http:
        port: 9090

    # Resource limits
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: 1000m
        memory: 2Gi

    # Query splitting and caching
    extraFlags:
    - --query-range.split-interval=24h
    - --query-range.max-retries-per-request=5
    - --query-frontend.compress-responses
    - --query-frontend.log-queries-longer-than=10s
    # Results cache (Redis)
    - --query-range.response-cache-config-file=/conf/cache/config.yaml
    # Labels cache (Memcached)
    - --labels.response-cache-config-file=/conf/cache/config.yaml

    # Cache configuration (using Memcached)
    extraVolumes:
    - name: cache-config
      configMap:
        name: thanos-cache-config

    extraVolumeMounts:
    - name: cache-config
      mountPath: /conf/cache
      readOnly: true

    # Pod Disruption Budget
    podDisruptionBudget:
      enabled: true
      minAvailable: 1

    # Anti-affinity
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
              - key: app.kubernetes.io/component
                operator: In
                values:
                - query-frontend
            topologyKey: kubernetes.io/hostname

    # Security Context
    securityContext:
      runAsNonRoot: true
      runAsUser: 65534
      fsGroup: 65534
      seccompProfile:
        type: RuntimeDefault

    containerSecurityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
        - ALL

  # --------------------------------------------------------------------------
  # Query - Aggregates data from Sidecars and Store Gateway
  # --------------------------------------------------------------------------
  query:
    enabled: true
    replicaCount: 2

    # Service configuration
    service:
      type: ClusterIP
      http:
        port: 9090
      grpc:
        port: 10901

    # Resource limits
    resources:
      requests:
        cpu: 1000m
        memory: 2Gi
      limits:
        cpu: 2000m
        memory: 4Gi

    # Query configuration
    extraFlags:
    - --query.timeout=15m
    - --query.max-concurrent=20
    - --query.lookback-delta=5m
    - --query.replica-label=replica
    - --query.replica-label=prometheus_replica
    # Auto-discover stores (sidecars, store gateways)
    - --store.unhealthy-timeout=5m

    # Store endpoints (auto-discovery via DNS)
    stores:
    - "dnssrv+_grpc._tcp.prometheus-stack-kube-prometheus-prometheus.monitoring.svc.cluster.local"
    - "dnssrv+_grpc._tcp.thanos-storegateway.monitoring.svc.cluster.local"

    # ServiceMonitor for Prometheus scraping
    serviceMonitor:
      enabled: true
      interval: 30s
      additionalLabels:
        prometheus: kube-prometheus

    # Pod Disruption Budget
    podDisruptionBudget:
      enabled: true
      minAvailable: 1

    # Anti-affinity
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
              - key: app.kubernetes.io/component
                operator: In
                values:
                - query
            topologyKey: kubernetes.io/hostname

    # Security Context
    securityContext:
      runAsNonRoot: true
      runAsUser: 65534
      fsGroup: 65534
      seccompProfile:
        type: RuntimeDefault

    containerSecurityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
        - ALL

  # --------------------------------------------------------------------------
  # Store Gateway - Queries historical data from S3
  # --------------------------------------------------------------------------
  storegateway:
    enabled: true
    replicaCount: 2

    # Service configuration
    service:
      type: ClusterIP
      http:
        port: 9090
      grpc:
        port: 10901

    # Resource limits (memory-intensive for index cache)
    resources:
      requests:
        cpu: 1000m
        memory: 4Gi
      limits:
        cpu: 2000m
        memory: 8Gi

    # Store Gateway configuration
    extraFlags:
    - --ignore-deletion-marks-delay=24h
    - --store.grpc.series-max-concurrency=20
    # Index cache (in-memory) - critical for query performance
    - --index-cache-size=2GB
    - --chunk-pool-size=2GB
    # Block sync frequency
    - --sync-block-duration=5m
    # Consistency delay (wait for Compactor to finish)
    - --consistency-delay=30m

    # Persistent volume for index cache
    persistence:
      enabled: true
      storageClass: gp3
      size: 50Gi  # Cache block metadata locally

    # Pod Disruption Budget
    podDisruptionBudget:
      enabled: true
      minAvailable: 1

    # Anti-affinity - spread across nodes
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
              - key: app.kubernetes.io/component
                operator: In
                values:
                - storegateway
            topologyKey: kubernetes.io/hostname

    # Security Context
    securityContext:
      runAsNonRoot: true
      runAsUser: 65534
      fsGroup: 65534
      seccompProfile:
        type: RuntimeDefault

    containerSecurityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
        - ALL

  # --------------------------------------------------------------------------
  # Compactor - Downsampling and retention management
  # --------------------------------------------------------------------------
  compactor:
    enabled: true
    replicaCount: 1  # Only 1 replica (uses leader election)

    # Service configuration
    service:
      type: ClusterIP
      http:
        port: 9090

    # Resource limits (CPU-intensive during compaction)
    resources:
      requests:
        cpu: 2000m
        memory: 4Gi
      limits:
        cpu: 4000m
        memory: 8Gi

    # Compactor configuration
    extraFlags:
    - --compact.concurrency=1
    - --delete-delay=48h
    # Downsampling: 5m resolution for data > 40h, 1h resolution for data > 10d
    - --downsampling.disable=false
    # Retention policies (applied to downsampled data)
    - --retention.resolution-raw=30d
    - --retention.resolution-5m=90d
    - --retention.resolution-1h=1y
    # Consistency delay
    - --consistency-delay=30m
    # Block sync frequency
    - --sync-block-duration=5m
    # Deduplication replica labels
    - --deduplication.replica-label=replica
    - --deduplication.replica-label=prometheus_replica

    # Persistent volume for temporary compaction data
    persistence:
      enabled: true
      storageClass: gp3
      size: 100Gi  # Temporary storage for compaction

    # Security Context
    securityContext:
      runAsNonRoot: true
      runAsUser: 65534
      fsGroup: 65534
      seccompProfile:
        type: RuntimeDefault

    containerSecurityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
        - ALL

  # --------------------------------------------------------------------------
  # Ruler - Alerting and recording rules on historical data
  # --------------------------------------------------------------------------
  ruler:
    enabled: false  # Optional: Enable if you need alerting on historical data
    replicaCount: 2

    # Service configuration
    service:
      type: ClusterIP
      http:
        port: 9090
      grpc:
        port: 10901

    # Resource limits
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: 1000m
        memory: 2Gi

    # Ruler configuration
    extraFlags:
    - --query=dnssrv+_http._tcp.thanos-query.monitoring.svc.cluster.local
    - --alertmanagers.url=http://prometheus-stack-kube-prometheus-alertmanager:9093
    - --rule-file=/etc/thanos-ruler/**/*.yaml
    - --data.retention=48h
    - --eval-interval=30s

    # Persistent volume for ruler state
    persistence:
      enabled: true
      storageClass: gp3
      size: 10Gi

    # Security Context
    securityContext:
      runAsNonRoot: true
      runAsUser: 65534
      fsGroup: 65534
      seccompProfile:
        type: RuntimeDefault

  # --------------------------------------------------------------------------
  # Bucket Web - UI for browsing S3 bucket contents
  # --------------------------------------------------------------------------
  bucketweb:
    enabled: true
    replicaCount: 1

    # Service configuration
    service:
      type: ClusterIP
      http:
        port: 8080

    # Resource limits
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 200m
        memory: 256Mi

    # Security Context
    securityContext:
      runAsNonRoot: true
      runAsUser: 65534
      fsGroup: 65534
      seccompProfile:
        type: RuntimeDefault

  # --------------------------------------------------------------------------
  # Metrics - Expose Thanos component metrics
  # --------------------------------------------------------------------------
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      interval: 30s
      additionalLabels:
        prometheus: kube-prometheus

  # --------------------------------------------------------------------------
  # IRSA (IAM Roles for Service Accounts) - AWS Integration
  # --------------------------------------------------------------------------
  serviceAccount:
    create: true
    name: thanos
    annotations:
      eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/thanos-s3-access  # Replace with actual IAM role ARN

---
# Cache Configuration ConfigMap (Memcached for Query Frontend)
apiVersion: v1
kind: ConfigMap
metadata:
  name: thanos-cache-config
  namespace: monitoring
data:
  config.yaml: |
    type: MEMCACHED
    config:
      addresses:
        - thanos-memcached:11211
      timeout: 500ms
      max_idle_connections: 100
      max_async_concurrency: 20
      max_async_buffer_size: 10000
      max_get_multi_concurrency: 100
      max_get_multi_batch_size: 0
      dns_provider_update_interval: 10s
      expiration: 24h

---
# Memcached Deployment for Query Frontend Caching
apiVersion: apps/v1
kind: Deployment
metadata:
  name: thanos-memcached
  namespace: monitoring
  labels:
    app: thanos-memcached
spec:
  replicas: 2
  selector:
    matchLabels:
      app: thanos-memcached
  template:
    metadata:
      labels:
        app: thanos-memcached
    spec:
      containers:
      - name: memcached
        image: memcached:1.6.29-alpine
        args:
        - -m 2048      # 2GB memory
        - -c 1024      # max connections
        - -I 5m        # max item size 5MB
        - -v           # verbose
        ports:
        - name: memcached
          containerPort: 11211
        resources:
          requests:
            cpu: 500m
            memory: 2Gi
          limits:
            cpu: 1000m
            memory: 2Gi
        securityContext:
          runAsNonRoot: true
          runAsUser: 11211
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL
      securityContext:
        seccompProfile:
          type: RuntimeDefault

---
apiVersion: v1
kind: Service
metadata:
  name: thanos-memcached
  namespace: monitoring
  labels:
    app: thanos-memcached
spec:
  type: ClusterIP
  ports:
  - name: memcached
    port: 11211
    targetPort: 11211
  selector:
    app: thanos-memcached
