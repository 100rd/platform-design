---
# Example Deployment for ARM64/Graviton Architecture
# This demonstrates how to deploy cost-optimized workloads on ARM64 Graviton nodes
apiVersion: apps/v1
kind: Deployment
metadata:
  name: arm64-nginx-example
  namespace: default
  labels:
    app: arm64-nginx
    architecture: arm64
    processor: graviton
    example: "true"
spec:
  replicas: 5
  selector:
    matchLabels:
      app: arm64-nginx
      architecture: arm64
  template:
    metadata:
      labels:
        app: arm64-nginx
        architecture: arm64
        processor: graviton
    spec:
      # Node selector to run on ARM64 Graviton nodes
      nodeSelector:
        kubernetes.io/arch: arm64
        karpenter.sh/nodepool: arm64-graviton

      # Anti-affinity to spread pods across nodes
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - arm64-nginx
                topologyKey: kubernetes.io/hostname

      # Tolerations for ARM64 nodes (if NodePool has taints)
      tolerations: []

      containers:
        - name: nginx
          # Multi-arch image - automatically pulls ARM64 variant
          image: nginx:1.27-alpine
          ports:
            - containerPort: 80
              name: http
              protocol: TCP

          # Resource requests trigger Karpenter node provisioning
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi

          # Liveness and readiness probes
          livenessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3

          # Environment variables to show architecture
          env:
            - name: ARCHITECTURE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.labels['kubernetes.io/arch']
            - name: PROCESSOR
              value: "AWS Graviton"
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName

          # Volume mounts
          volumeMounts:
            - name: nginx-config
              mountPath: /usr/share/nginx/html/index.html
              subPath: index.html
              readOnly: true

      # Volumes
      volumes:
        - name: nginx-config
          configMap:
            name: arm64-nginx-config

---
# ConfigMap with custom HTML page
apiVersion: v1
kind: ConfigMap
metadata:
  name: arm64-nginx-config
  namespace: default
data:
  index.html: |
    <!DOCTYPE html>
    <html>
    <head>
        <title>ARM64 Graviton Example on Karpenter</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 800px;
                margin: 50px auto;
                padding: 20px;
                background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
                color: white;
            }
            .container {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 10px;
                padding: 30px;
                backdrop-filter: blur(10px);
            }
            h1 { margin-top: 0; }
            .info { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 5px; margin: 10px 0; }
            .label { font-weight: bold; color: #ffd700; }
            .savings { background: rgba(255, 215, 0, 0.2); padding: 10px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #ffd700; }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üí™ ARM64/Graviton Architecture Example</h1>
            <div class="info">
                <p><span class="label">Architecture:</span> ARM64 (aarch64)</p>
                <p><span class="label">Processor:</span> AWS Graviton (ARM-based)</p>
                <p><span class="label">Node Pool:</span> arm64-graviton</p>
                <p><span class="label">Provisioner:</span> Karpenter</p>
                <p><span class="label">Platform:</span> Amazon EKS</p>
            </div>

            <div class="savings">
                <h3 style="margin-top:0;">üí∞ Cost Savings with Graviton</h3>
                <ul style="margin-bottom:0;">
                    <li><strong>20-40% better price/performance</strong> vs comparable x86 instances</li>
                    <li><strong>Up to 60% better energy efficiency</strong></li>
                    <li><strong>Lower total cost of ownership (TCO)</strong></li>
                </ul>
            </div>

            <h2>About this Deployment</h2>
            <p>This application is running on AWS Graviton processors (ARM64 architecture) automatically provisioned by Karpenter for cost-optimized workloads.</p>

            <h3>Graviton Benefits:</h3>
            <ul>
                <li>Modern ARM Neoverse cores</li>
                <li>Excellent for: web apps, microservices, data processing</li>
                <li>Native ARM64 support in most container images</li>
                <li>Best price/performance ratio on AWS</li>
                <li>Lower latency and higher throughput</li>
            </ul>

            <h3>Graviton Instance Families:</h3>
            <ul>
                <li><strong>Graviton3:</strong> m7g, c7g, r7g (latest, best performance)</li>
                <li><strong>Graviton2:</strong> m6g, c6g, r6g, t4g</li>
                <li><strong>Network Optimized:</strong> c7gn (up to 200 Gbps)</li>
                <li><strong>Storage Optimized:</strong> m7gd, c7gd, r7gd (NVMe SSD)</li>
            </ul>

            <h3>Workload Compatibility:</h3>
            <ul>
                <li>‚úÖ Node.js, Python, Java, Go, Rust</li>
                <li>‚úÖ Containers with multi-arch images</li>
                <li>‚úÖ Most open-source software</li>
                <li>‚úÖ Databases (PostgreSQL, MySQL, Redis, MongoDB)</li>
                <li>‚ö†Ô∏è May require recompilation for proprietary software</li>
            </ul>
        </div>
    </body>
    </html>

---
# Service to expose the deployment
apiVersion: v1
kind: Service
metadata:
  name: arm64-nginx-service
  namespace: default
  labels:
    app: arm64-nginx
    architecture: arm64
    processor: graviton
spec:
  type: ClusterIP
  selector:
    app: arm64-nginx
    architecture: arm64
  ports:
    - name: http
      port: 80
      targetPort: http
      protocol: TCP

---
# HorizontalPodAutoscaler for automatic scaling
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: arm64-nginx-hpa
  namespace: default
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: arm64-nginx-example
  minReplicas: 5
  maxReplicas: 20
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 50
          periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
        - type: Percent
          value: 100
          periodSeconds: 30
        - type: Pods
          value: 3
          periodSeconds: 30
      selectPolicy: Max

---
# PodDisruptionBudget to maintain availability during disruptions
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: arm64-nginx-pdb
  namespace: default
spec:
  minAvailable: 3
  selector:
    matchLabels:
      app: arm64-nginx
      architecture: arm64
