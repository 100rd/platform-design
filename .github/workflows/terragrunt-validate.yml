name: Terragrunt Validate

on:
  push:
    branches: [main, feature/terragrunt]
    paths:
      - "terragrunt/**"
      - "catalog/**"
      - ".github/workflows/terragrunt-validate.yml"
  pull_request:
    paths:
      - "terragrunt/**"
      - "catalog/**"
  workflow_dispatch:

jobs:
  hclfmt:
    name: HCL Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Terragrunt
        run: |
          TERRAGRUNT_VERSION="0.68.12"
          curl -Lo terragrunt "https://github.com/gruntwork-io/terragrunt/releases/download/v${TERRAGRUNT_VERSION}/terragrunt_linux_amd64"
          chmod +x terragrunt
          sudo mv terragrunt /usr/local/bin/
      - name: Check HCL formatting
        run: |
          UNFORMATTED=$(terragrunt hclfmt --check --diff 2>&1) || true
          if [ -n "$UNFORMATTED" ]; then
            echo "::error::The following HCL files are not formatted:"
            echo "$UNFORMATTED"
            exit 1
          fi

  validate-catalog:
    name: Validate Catalog Units
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate HCL syntax (balanced braces)
        shell: bash
        run: |
          ERRORS=0
          while IFS= read -r f; do
            OPENS=$(grep -o '{' "$f" | wc -l)
            CLOSES=$(grep -o '}' "$f" | wc -l)
            if [ "$OPENS" -ne "$CLOSES" ]; then
              echo "::error file=${f}::Unbalanced braces: ${OPENS} open, ${CLOSES} close"
              ERRORS=$((ERRORS + 1))
            fi
          done < <(find catalog/ terragrunt/ -name '*.hcl' -not -path '*/.terragrunt-cache/*')
          if [ "$ERRORS" -gt 0 ]; then
            echo "::error::Found $ERRORS HCL files with syntax issues"
            exit 1
          fi
          echo "All HCL files passed basic syntax validation"
