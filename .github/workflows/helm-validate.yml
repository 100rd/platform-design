name: Helm Chart Validation

on:
  push:
    branches: [main, feature/terragrunt]
  pull_request:

jobs:
  kubeconform:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4  # Updated from v3
      - name: Setup Helm
        uses: azure/setup-helm@v4  # Updated from v3
      - name: Install kubeconform
        run: |
          KUBECONFORM_VERSION="v0.6.7"
          curl -Lo kubeconform.tar.gz "https://github.com/yannh/kubeconform/releases/download/${KUBECONFORM_VERSION}/kubeconform-linux-amd64.tar.gz"
          tar -xzf kubeconform.tar.gz
          sudo mv kubeconform /usr/local/bin/
      - name: Validate Helm charts
        run: |
          FAILED=0
          for chart in $(find . -name Chart.yaml -not -path './.git/*' -exec dirname {} ';'); do
            echo "Validating chart: $chart"
            if ! helm template "$chart" 2>/dev/null | kubeconform \
              -strict \
              -summary \
              -kubernetes-version 1.32.0 \
              -schema-location default \
              -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json'; then
              echo "FAILED: $chart"
              FAILED=1
            fi
          done
          if [ "$FAILED" -eq 1 ]; then
            echo "::error::One or more Helm chart validations failed"
            exit 1
          fi
